<!DOCTYPE html>
<html>
<head>
    <title>SJTU Single Sign On</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0"/>
    <base href="/jaccount/"/>
    <link rel="icon" type="image/x-icon" href="image/favicon.png?v=20161228" />
    <link href="css/login.css?v=20220429" rel="stylesheet"/>
    <script>
        function setLocale(value) {
            var href = window.location.href;
            var regex = new RegExp("[&\\?]locale=");
            if(regex.test(href)) {
                regex = new RegExp("([&\\?])locale=\\w+");
                window.location.href = href.replace(regex, "$1locale=" + value);
            } else {
                if(href.indexOf("?") > -1)
                    window.location.href = href + "&locale=" + value;
                else
                    window.location.href = href + "?locale=" + value;
            }
        }
    </script>
    <script src="js/jquery-1.7.1.js" type="text/javascript"></script>
    </head>
<body>
<noscript>JavaScript disabled, please enable JavaScript before login jAccount</noscript>
<div id="page">
    <div id="header" class="clearfix">
        <div class="container">
            <div class="logo">
                <img src="image/sjtu.png?v=20161228" border="0"/>
            </div>
            <div class="i18n action-control">
                <a href="javascript:setLocale('zh')">中文</a> | <a href="javascript:setLocale('en')">EN</a>
            </div>
        </div>
    </div>
    <div id="content">
        <div class="container">
            <div class="login-bg"></div>
            <div class="login-layout">




<script>

    var navigating = false;
    var hasSub = false,
        subFailed = false;
    var websocket = null;
    var firefox = navigator.userAgent.toLowerCase().indexOf("firefox") != -1;

    function addEvent(html_element, event_name, event_function) {
        if (html_element.addEventListener) { // Modern
            html_element.addEventListener(event_name, event_function, false);
        } else if (html_element.attachEvent) { // Internet Explorer
            html_element.attachEvent("on" + event_name, event_function);
        } else { // others
            html_element["on" + event_name] = event_function;
        }
    }

    function showQr(url, msg) {
        var img = document.getElementById('qr-img');
        if (img != null) {
            img.src = url;
        }
        if (msg != null) {
            var msgSpan = document.getElementById('qr-msg');
            if (msgSpan != null) {
                msgSpan.innerHTML = msg;
            }
        }
    }

    function showTryAppLogin(timeout) {
        var waitDiv = document.getElementById('login-app-wait'),
            spinnerDiv = document.getElementById('login-app-spinner'),
            downloadDiv = document.getElementById('login-app-download'),
            failDiv = document.getElementById('login-app-fail');
        if (waitDiv != null) {
            waitDiv.setAttribute('class', 'show');
            waitDiv.removeAttribute('style');
            spinnerDiv.removeAttribute('class');
            downloadDiv.removeAttribute('class');
            failDiv.removeAttribute('class');
        }

        return setTimeout(function () {
            waitDiv.setAttribute('class', 'show download');
            spinnerDiv.setAttribute('class', 'hide');
            downloadDiv.setAttribute('class', 'show');
            failDiv.removeAttribute('class');
        }, timeout);
    }

    function showTryAppFailed() {
        var waitDiv = document.getElementById('login-app-wait'),
            spinnerDiv = document.getElementById('login-app-spinner'),
            downloadDiv = document.getElementById('login-app-download'),
            failDiv = document.getElementById('login-app-fail');
        waitDiv.setAttribute('class', 'show');
        spinnerDiv.setAttribute('class', 'hide');
        downloadDiv.removeAttribute('class');
        failDiv.setAttribute('class', 'show');
        setTimeout(function () {
            waitDiv.removeAttribute('class');
        }, 5000)
    }

    function downloadApp() {
        window.location.href = "https://form.sjtu.edu.cn/mobile/download.jsp";
    }

    function cancelAppLogin() {
        var waitDiv = document.getElementById('login-app-wait');
        if (waitDiv != null) {
            waitDiv.removeAttribute('class');
        }
    }

    function sub() {
        if (navigating) {
            return;
        }
        if (!hasSub || subFailed) {
            hasSub = true;

            if ('WebSocket' in window) {
                var pageUrl = window.location, socketUrl;
                if (pageUrl.protocol === "https:") {
                    socketUrl = "wss:";
                } else {
                    socketUrl = "ws:";
                }
                socketUrl += "//" + pageUrl.host;
                socketUrl += "/jaccount/sub/44b983c1-aae9-4369-a577-13e0c068f651";
                websocket = new WebSocket(socketUrl);
                websocket.onmessage = function(event) {
                    var msg = JSON.parse(event.data);
                    switch (msg.type) {
                        case 'UPDATE_QR_CODE':
                            showQr('qrcode?uuid=44b983c1-aae9-4369-a577-13e0c068f651&ts=' + msg.payload.ts + '&sig=' + msg.p.sig);
                            break;
                        case 'ERROR_MESSAGE':
                            break;
                        case 'LOGIN':
                            navigating = true;
                            window.location.href = "expresslogin?uuid=44b983c1-aae9-4369-a577-13e0c068f651";
                            break;
                    }
                };
                websocket.onopen = function() {
                    subFailed = false;
                    afterSubSuccess();
                };
                websocket.onerror = function() {
                    afterSubFailed();
                };
                websocket.onclose = function(event) {
                    hasSub = false;
                    showQr('', 'Connection reset, please refresh login page');
                    if (event.code == 1001) { //GOING_AWAY
                        setTimeout(sub, 1000);
                    } else if (event.code == 1006) { //CLOSED_ABNORMALLY
                        setTimeout(sub, 5000);
                    }
                };
            } else {
                afterSubFailed()
            }
        }
    };

    function afterSubSuccess() {
        if (hasSub && !subFailed) {
            try {
                websocket.send('{ "type": "UPDATE_QR_CODE" }');
                setTimeout(afterSubSuccess, 60000);
            } catch (ex) {
                try {
                    websocket.close();
                } catch (ignored) {}
            }
        }
    }

    function afterSubFailed() {
        subFailed = true;
        showQr('', 'Load QR code failed');
    }

    var captchaCheckStatus = null;

    function setCaptchaCheckStatus(status) {
        if (captchaCheckStatus != null && captchaCheckStatus != 'waiting') {
            return;
        }
        captchaCheckStatus = status;
        if (status == 'waiting') {
            $("#captcha-verify").show();
            return;
        }
        $("#captcha-verify").hide();
        if (status == 'passed') {
            if ($.support.leadingWhitespace) {
                $("#operate-buttons").slideDown();
            } else {
                $("#operate-buttons").show();
            }
            return;
        }
        showCaptcha();
    }

    function showCaptcha() {
        refreshCaptcha();
        if ($.support.leadingWhitespace) {
            $("#captcha-box").slideDown(function () {
                $("#operate-buttons").slideDown();
            });
        } else {
            $("#captcha-box").show();
            $("#operate-buttons").show();
        }
    }

    function refreshCaptcha() {
        var img = document.getElementById('captcha-img');
        if (img != null) {
            img.src = 'captcha?uuid=44b983c1-aae9-4369-a577-13e0c068f651&t=' + (new Date()).getTime();
        }
    }

    var submitted = false;
    var captchaObj = null;

    var checkForm = function (button) {

        if (submitted === true) {
            return false;
        }

        var warnUl = $("#ul_warn"),
            tip_no_user = $("#li_tip_no_user"),
            tip_no_password = $("#li_tip_no_password"),
            tip_no_captcha = $("#li_tip_no_captcha"),
            warnDiv = $("#div_warn"),
            user = $("#user"),
            password = $("#pass"),
            captcha = $("#captcha");

        if (warnDiv != null) {
            warnDiv.css("display", "none");
        }

        warnUl.css("display", "none");
        tip_no_user.css("display", "none");